---
// src/pages/blog/[slug].astro (JavaScript Odaklı)

import Layout from "../../layouts/Layout.astro";
import { client as sanityClient } from '../../lib/sanityClient';
import { urlFor } from '../../lib/sanityImageUrl';
import { Image } from "astro:assets";
import { PortableText } from 'astro-portabletext';
import { formatDate } from "../../utils/formatDate"; // Bu dosyanın src/utils/ altında olduğundan emin olun

export async function getStaticPaths() {
  const query = `*[_type == "post" && defined(slug.current) && !(_id in path("drafts.**"))]{ "slug": slug.current }`;
  const postsFromSanity = await sanityClient.fetch(query);

  return postsFromSanity.map((post) => ({
    params: { slug: post.slug },
    props: { slug: post.slug },
  }));
}

const { slug } = Astro.props;

const postQuery = `*[_type == "post" && slug.current == $slug][0]{
  _id,
  title,
  "slugValue": slug.current,
  mainImage,
  author->{
    name
  },
  publishedAt,
  body,
  excerpt
}`;

const post = await sanityClient.fetch(postQuery, { slug });

if (!post) {
  return Astro.redirect('/404');
}

const pageTitle = post.title || "Blog Yazısı";
const metaDescription = post.excerpt || (post.title ? post.title.slice(0, 160) : "Detaylı bilgi için tıklayın.");
let ogImageUrl = undefined; // undefined olarak başlatmak daha iyi

if (post.mainImage && post.mainImage.asset) {
  const imageUrlResult = urlFor(post.mainImage);
  if (imageUrlResult) {
    ogImageUrl = imageUrlResult.width(1200).height(630).fit('crop').auto('format').url();
  }
}

// --- customPortableTextComponents Tanımı (JavaScript) ---
const customPortableTextComponents = {
  types: {
    image: ({ value }) => { // JavaScript'te tip belirtmeye gerek yok
      if (!value || !value.asset) return null;
      const imageUrlResult = urlFor(value); // Tip belirtmeden çağırıyoruz
      if (!imageUrlResult) return null;
      const imageUrl = imageUrlResult.width(800).auto('format').url();
      // String HTML döndürüyoruz
      return `<img src="${imageUrl}" alt="${value.alt || 'İçerik görseli'}" class="wow fadeInUp my-6 rounded-[5px] shadow-md" data-wow-delay=".1s" />`;
    },
  },
  marks: {
    link: ({ children, value }) => { // JavaScript'te tip belirtmeye gerek yok
      const href = value?.href; // Opsiyonel zincirleme
      if (!href) {
        // Children'ı güvenli bir şekilde string'e çevir
        const childrenText = Array.isArray(children)
          ? children.map(child => (typeof child === 'string' ? child : (child?.text || ''))).join('')
          : String(children || '');
        return childrenText;
      }
      const childrenText = Array.isArray(children)
        ? children.map(child => (typeof child === 'string' ? child : (child?.text || ''))).join('')
        : String(children || '');
      const rel = href.startsWith('/') ? undefined : 'noopener noreferrer';
      const target = href.startsWith('/') ? undefined : '_blank';
      // String HTML döndürüyoruz
      return `<a href="${href}" rel="${rel}" target="${target}" class="text-primary hover:underline">${childrenText}</a>`;
    },
  },
  // block, list, listItem için varsayılan render'ı kullanıyoruz
};
// --- customPortableTextComponents Tanımı SONU ---

---

<Layout title={pageTitle} description={metaDescription} image={ogImageUrl} type="article">
  <section class="pt-20 pb-10 lg:pt-[120px] lg:pb-20 dark:bg-dark">
    <div class="container">
      <div class="-mx-4 flex flex-wrap justify-center">
        <div class="w-full px-4 lg:w-8/12">
          <div class="wow fadeInUp relative z-20 mb-[50px] h-[300px] overflow-hidden rounded-[5px] md:h-[400px] lg:h-[500px]" data-wow-delay=".1s">
            {(post.mainImage && post.mainImage.asset && urlFor(post.mainImage)) ? (
              <Image
                src={urlFor(post.mainImage).width(1000).height(550).auto('format').url()}
                alt={post.mainImage.alt || pageTitle}
                width={1000}
                height={550}
                class="h-full w-full object-cover object-center"
              />
            ) : (
              <div class="h-full w-full bg-gray-300 dark:bg-gray-700 flex items-center justify-center">
                <span class="text-gray-500">Ana Görsel Yok</span>
              </div>
            )}
            <div class="absolute top-0 left-0 z-10 flex h-full w-full items-end bg-gradient-to-t from-dark-700 to-transparent">
              <div class="flex flex-wrap items-center p-4 pb-4 sm:px-8">
                {post.author?.name && (
                  <div class="mb-4 mr-5 flex items-center md:mr-10">
                    <p class="text-base font-medium text-white">
                      Yazar:
                      <a href="#" class="text-white hover:opacity-70">
                        {post.author.name}
                      </a>
                    </p>
                  </div>
                )}
                <div class="mb-4 flex items-center">
                  <p class="mr-5 flex items-center text-sm font-medium text-white md:mr-6">
                    <span class="mr-3">
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="fill-current"><path d="M13.9998 2.6499H12.6998V2.0999C12.6998 1.7999 12.4498 1.5249 12.1248 1.5249C11.7998 1.5249 11.5498 1.7749 11.5498 2.0999V2.6499H4.4248V2.0999C4.4248 1.7999 4.1748 1.5249 3.8498 1.5249C3.5248 1.5249 3.2748 1.7749 3.2748 2.0999V2.6499H1.9998C1.1498 2.6499 0.424805 3.3499 0.424805 4.2249V12.9249C0.424805 13.7749 1.1248 14.4999 1.9998 14.4999H13.9998C14.8498 14.4999 15.5748 13.7999 15.5748 12.9249V4.1999C15.5748 3.3499 14.8498 2.6499 13.9998 2.6499ZM1.5748 7.2999H3.6998V9.7749H1.5748V7.2999ZM4.8248 7.2999H7.4498V9.7749H4.8248V7.2999ZM7.4498 10.8999V13.3499H4.8248V10.8999H7.4498V10.8999ZM8.5748 10.8999H11.1998V13.3499H8.5748V10.8999ZM8.5748 9.7749V7.2999H11.1998V9.7749H8.5748ZM12.2998 7.2999H14.4248V9.7749H12.2998V7.2999ZM1.9998 3.7749H3.2998V4.2999C3.2998 4.5999 3.5498 4.8749 3.8748 4.8749C4.1998 4.8749 4.4498 4.6249 4.4498 4.2999V3.7749H11.5998V4.2999C11.5998 4.5999 11.8498 4.8749 12.1748 4.8749C12.4998 4.8749 12.7498 4.6249 12.7498 4.2999V3.7749H13.9998C14.2498 3.7749 14.4498 3.9749 14.4498 4.2249V6.1749H1.5748V4.2249C1.5748 3.9749 1.7498 3.7749 1.9998 3.7749ZM1.5748 12.8999V10.8749H3.6998V13.3249H1.9998C1.7498 13.3499 1.5748 13.1499 1.5748 12.8999ZM13.9998 13.3499H12.2998V10.8999H14.4248V12.9249C14.4498 13.1499 14.2498 13.3499 13.9998 13.3499Z" /></svg>
                    </span>
                    {formatDate(post.publishedAt)}
                  </p>
                </div>
              </div>
            </div>
          </div>
          <div class="-mx-4 flex flex-wrap">
            <div class="w-full px-4">
              <div class="prose dark:prose-invert prose-lg max-w-none mx-auto
                          prose-headings:font-semibold prose-headings:text-dark prose-headings:dark:text-white
                          prose-p:text-body-color prose-p:dark:text-dark-6
                          prose-a:text-primary prose-a:hover:underline
                          prose-strong:text-dark prose-strong:dark:text-white
                          prose-blockquote:border-primary prose-blockquote:text-dark prose-blockquote:dark:text-white">
                {post.body && <PortableText value={post.body} components={customPortableTextComponents} />}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>